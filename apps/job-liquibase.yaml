apiVersion: v1
kind: Namespace
metadata:
  name: migrations

---
apiVersion: batch/v1
kind: Job
metadata:
  name: liquibase-migration
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  template:
    spec:
      restartPolicy: Never
      initContainers:
        - name: git-clone
          image: alpine/git:latest
          command:
            - /bin/sh
            - -c
            - |
              git clone https://github.com/zonex5/service-a /workspace
          volumeMounts:
            - name: changelog-volume
              mountPath: /workspace
      containers:
        - name: liquibase
          image: liquibase/liquibase:latest
          env:
            - name: LIQUIBASE_URL
              value: "jdbc:postgresql://172.18.208.3:5432/service_a"
            - name: LIQUIBASE_USERNAME
              value: "postgres"
            - name: LIQUIBASE_PASSWORD
              value: "postgres"
          args:
            - "--changeLogFile=/migrations/changelog.xml"
            - "update"
          volumeMounts:
            - name: changelog-volume
              mountPath: /liquibase
      volumes:
        - name: changelog-volume
          emptyDir: {}